__includes [ "new_world.nls" "helper_new.nls" ]

buses-own [
  ; Static, read-only variables. These values never change. You can read them, but you cannot change them.
  bus_id          ; The ID of a given agent (bus). Each agent has a unique ID.
  bus_type        ; The type of a given agent (bus). 1 means "small", 2 means "medium" and 3 means "large".
  ; Dynamic, read-only variables. These values may change over time. You can read them, but you cannot change them.
  inbox           ; List containing all the incoming messages (a given message is a list like this [tick sender message]).
  bus_passengers  ; List containing all the passengers that the agent (bus) is currently carrying (represented as a list like this [passenger_id bus_stop]).
  previous_stop   ; ID of the last bus stop that the agent (bus) visited (-1 means that the agent has not visited any bus stop yet).
  current_stop    ; ID of the bus stop where the agent (bus) currently is (-1 means that the agent is not at any bus stop).
  next_stop       ; ID of the bus stop the agent (bus) is traveling to (-1 means that the agent is not travelling to any bus stop).

  ; local variables
  known_route     ; Assessed route for this bus (with respect to levels hyperparam)
  distance_mat    ; a matrix containing the shortest distance from one bus stop to the other (also considering paths that are not directly connected)

  ; ORACLE exclusive
  night_team      ; a list of buses to be added at 0:00
  morning_team    ; a list of buses to be added at 6:00
  total_capacity  ; total capacity in the world
  position_belief ; belief of positions of all buses
  history         ; an n-tick history of the growth of population needed to infer what size bus to add
  add_bus_threshold
  need_thresh_1   ; above how much 'need' we should add a bus of type 1
  need_thresh_2   ; above how much 'need' we should add a bus of type 2
  need_thresh_3   ; above how much 'need' we should add a bus of type 3
  total_ticks_per_day
  wait_for_votes  ; a boolean that tells the oracle to not send out a voting request each tick it's waiting on a response to the previous voting round
]


globals [
  graph
]


to init-buses
  ; Initialize Agents

  ; General, immutable global/local variables
  set graph [ [22 15 14] [11 19 23 7] [8] [16 4 20 9] [3 5 10] [4 16 10 17] [8] [1 17 13]
              [2 6 9] [3 8 20] [4 5 17 13 21] [1 16 17] [20 15 22] [7 10 22 23] [0 23] [0 12 18]
              [3 5 11] [5 7 10 11] [15] [1 23] [3 9 12 21] [10 20 22] [0 12 13 21] [1 13 14 19]
  ]

  set distance_mat [[0 18.1085370140267 31.6327052439869 21.4946426457950 18.3323649856266 16.3956231322022 34.2316371008528 24.3754810957648 27.1605692889873 23.9982916288189 13.2333454720339 22.1085370140267 13.7924234729030 10.2333454720339 7.28010988928052 4.12310562561766 20.6382638193215 21.2333454720339 10.2058681559159 20.1085370140267 19.8751860032013 19.5579007923706 3.16227766016838 10.1085370140267]
                  [18.1085370140267  0  22.0327592528361  11.2360679774998  14.3983456376682  13.2426406871193  24.6316911097020  6.32455532033676  17.5606232978366  14.3983456376682  16.4049183472877  4  24.3898983196635  15.2111025509280  10.8284271247462  22.2316426396444  9  11.4235748339295  28.3144051699426  2.23606797749979  18.3071357893653  22.5497764764846  21.2708146741951  8]
                  [31.6327052439869  22.0327592528361  0  10.7966912753363  13.9589689355047  16.7873960602509  11.5432037668651  27.9691781041419  4.47213595499958  7.63441361516796  19.0579884490975  18.0327592528361  17.8402817710838  22.0579884490975  32.0975181247717  31.9824173948148  13.0327592528361  22.8701585905491  38.0651799251130  24.2688272303359  11.7575192407856  16.0001599279049  28.4704275838185  29.2690910000255]
                  [21.4946426457950  11.2360679774998  10.7966912753363  0  3.16227766016838  5.99070478491457  13.3956231322022  17.1724868288056  6.32455532033676  3.16227766016838  8.26129717376116  7.23606797749979  13.1538303421637  11.2612971737612  21.3008268494353  25.6177482714127  2.23606797749979  12.0734673152128  31.7005108017109  13.4721359549996  7.07106781186548  11.3137084989848  18.3323649856266  18.4723997246891]
                  [18.3323649856266  14.3983456376682  13.9589689355047  3.16227766016838  0  2.82842712474619  16.5579007923706  14.0102091686372  9.48683298050514  6.32455532033676  5.09901951359278  10.3983456376682  16.3161080023321  8.09901951359278  18.1385491892670  22.4554706112443  5.39834563766817  8.91118965504441  28.5382331415425  16.6344136151680  10.2333454720339  11.4235748339295  15.1700873254583  15.3101220645208]
                  [16.3956231322022  13.2426406871193  16.7873960602509  5.99070478491457  2.82842712474619  0  19.3863279171168  11.1817820438910  12.3152601052513  9.15298244508295  3.16227766016838  9.24264068711928  19.1445351270783  6.16227766016838  16.2018073358426  20.5187287578199  4.24264068711929  6.08276253029822  26.6014912881181  15.4787086646191  13.0617725967800  9.48683298050514  13.2333454720339  13.3733802110964]
                  [34.2316371008528  24.6316911097020  11.5432037668651  13.3956231322022  16.5579007923706  19.3863279171168  0  30.5681099610078  7.07106781186548  10.2333454720339  21.6569203059634  20.6316911097020  20.4392136279497  24.6569203059634  34.6964499816376  34.5813492516807  15.6316911097020  25.4690904474150  40.6641117819789  26.8677590872018  14.3564510976515  18.5990917847708  31.0693594406844  31.8680228568914]
                  [24.3754810957648  6.32455532033676  27.9691781041419  17.1724868288056  14.0102091686372  11.1817820438910  30.5681099610078  0  23.4970421491423  20.3347644889740  13.0990195135928  10.3245553203368  29.7489780513470  14.1421356237310  17.1529824450830  28.4985867213825  15.3245553203368  5.09901951359278  34.5813492516807  8.56062329783655  23.6662155210488  19.4235748339295  21.2132034355964  14.3245553203368]
                  [27.1605692889873  17.5606232978366  4.47213595499958  6.32455532033676  9.48683298050514  12.3152601052513  7.07106781186548  23.4970421491423  0  3.16227766016838  14.5858524940979  13.5606232978366  13.3681458160843  17.5858524940979  27.6253821697721  27.5102814398152  8.56062329783655  18.3980226355495  33.5930439701134  19.7966912753363  7.28538328578604  11.5280239729053  23.9982916288189  24.7969550450259]
                  [23.9982916288189  14.3983456376682  7.63441361516796  3.16227766016838  6.32455532033676  9.15298244508295  10.2333454720339  20.3347644889740  3.16227766016838  0  11.4235748339295  10.3983456376682  10.2058681559159  14.4235748339295  24.4631045096037  24.3480037796468  5.39834563766817  15.2357449753812  30.4307663099451  16.6344136151680  4.12310562561766  8.36574631273695  20.8360139686505  21.6346773848575]
                  [13.2333454720339  16.4049183472877  19.0579884490975  8.26129717376116  5.09901951359278  3.16227766016838  21.6569203059634  13.0990195135928  14.5858524940979  11.4235748339295  0  12.4049183472877  16.6499585377543  3  13.0395296756742  17.3564510976515  7.40491834728766  8  23.4392136279497  18.6409863247875  10.5671960074560  6.32455532033676  10.0710678118655  10.2111025509280]
                  [22.1085370140267  4  18.0327592528361  7.23606797749979  10.3983456376682  9.24264068711928  20.6316911097020  10.3245553203368  13.5606232978366  10.3983456376682  12.4049183472877  0  20.3898983196635  15.4049183472877  14.8284271247462  26.2316426396444  5  8.54400374531753  32.3144051699426  6.23606797749979  14.3071357893653  18.5497764764846  22.4759861591531  12]
                  [13.7924234729030  24.3898983196635  17.8402817710838  13.1538303421637  16.3161080023321  19.1445351270783  20.4392136279497  29.7489780513470  13.3681458160843  10.2058681559159  16.6499585377543  20.3898983196635  0  17.7012136246001  21.0725333621836  14.1421356237310  15.3898983196635  24.6499585377543  20.2248981540292  26.6259662971633  6.08276253029822  10.3254032174175  10.6301458127347  23.9009604869297]
                  [10.2333454720339  15.2111025509280  22.0579884490975  11.2612971737612  8.09901951359278  6.16227766016838  24.6569203059634  14.1421356237310  17.5858524940979  14.4235748339295  3  15.4049183472877  17.7012136246001  0  10.0395296756742  14.3564510976515  10.4049183472877  11  20.4392136279497  17.2111025509280  13.5671960074560  9.32455532033676  7.07106781186548  7.21110255092798]
                  [7.28010988928052  10.8284271247462  32.0975181247717  21.3008268494353  18.1385491892670  16.2018073358426  34.6964499816376  17.1529824450829  27.6253821697721  24.4631045096037  13.0395296756742  14.8284271247462  21.0725333621836  10.0395296756742  0  11.4032155148982  19.8284271247462  21.0395296756742  17.4859780451964  12.8284271247462  23.6067256831302  19.3640849960109  10.4423875494489  2.82842712474619]
                  [4.12310562561766  22.2316426396444  31.9824173948148  25.6177482714127  22.4554706112443  20.5187287578199  34.5813492516807  28.4985867213825  27.5102814398152  24.3480037796468  17.3564510976515  26.2316426396444  14.1421356237310  14.3564510976515  11.4032155148982  0  24.7613694449392  25.3564510976515  6.08276253029822  24.2316426396444  20.2248981540292  23.6810064179883  7.28538328578604  14.2316426396444]
                  [20.6382638193215  9  13.0327592528361  2.23606797749979  5.39834563766817  4.24264068711929  15.6316911097020  15.3245553203368  8.56062329783655  5.39834563766817  7.40491834728766  5  15.3898983196635  10.4049183472877  19.8284271247462  24.7613694449392  0  10.3254032174175  30.8441319752374  11.2360679774998  9.30713578936527  13.5497764764846  17.4759861591531  17]
                  [21.2333454720339  11.4235748339295  22.8701585905491  12.0734673152128  8.91118965504441  6.08276253029822  25.4690904474150  5.09901951359278  18.3980226355495  15.2357449753812  8  8.54400374531753  24.6499585377543  11  21.0395296756742  25.3564510976515  10.3254032174175  0  31.4392136279497  13.6596428114293  18.5671960074560  14.3245553203368  18.0710678118655  18.2111025509280]
                  [10.2058681559159  28.3144051699426  38.0651799251130  31.7005108017109  28.5382331415425  26.6014912881181  40.6641117819789  34.5813492516807  33.5930439701134  30.4307663099451  23.4392136279497  32.3144051699426  20.2248981540292  20.4392136279497  17.4859780451964  6.08276253029822  30.8441319752374  31.4392136279497  0  30.3144051699426  26.3076606843274  29.7637689482865  13.3681458160843  20 3144051699426]
                  [20.1085370140267  2.23606797749979  24.2688272303359  13.4721359549996  16.6344136151680  15.4787086646191  26.8677590872018  8.56062329783655  19.7966912753363  16.6344136151680  18.6409863247875  6.23606797749979  26.6259662971633  17.2111025509280  12.8284271247462  24.2316426396444  11.2360679774998  13.6596428114293  30.3144051699426  0  20.5432037668651  24.7858444539843  23.2708146741951  10]
                  [19.8751860032012  18.3071357893653  11.7575192407856  7.07106781186548  10.2333454720339  13.0617725967800  14.3564510976515  23.6662155210488  7.28538328578604  4.12310562561766  10.5671960074560  14.3071357893653  6.08276253029822  13.5671960074560  23.6067256831302  20.2248981540292  9.30713578936527  18.5671960074560  26.3076606843274  20.5432037668651  0  4.24264068711929  16.7129083430329  20.7782985583840]
                  [19.5579007923706  22.5497764764846  16.0001599279049  11.3137084989848  11.4235748339295  9.48683298050514  18.5990917847708  19.4235748339295  11.5280239729053  8.36574631273695  6.32455532033676  18.5497764764846  10.3254032174175  9.32455532033676  19.3640849960109  23.6810064179883  13.5497764764846  14.3245553203368  29.7637689482865  24.7858444539843  4.24264068711929  0  16.3956231322022  16.5356578712647]
                  [3.16227766016838  21.2708146741951  28.4704275838185  18.3323649856266  15.1700873254583  13.2333454720339  31.0693594406844  21.2132034355964  23.9982916288189  20.8360139686505  10.0710678118655  22.4759861591531  10.6301458127347  7.07106781186548  10.4423875494489  7.28538328578604  17.4759861591531  18.0710678118655  13.3681458160843  23.2708146741951  16.7129083430329  16.3956231322022  0  13.2708146741951]
                  [10.1085370140267  8  29.2690910000255  18.4723997246891  15.3101220645208  13.3733802110964  31.8680228568914  14.3245553203368  24.7969550450259  21.6346773848575  10.2111025509280  12  23.9009604869297  7.21110255092798  2.82842712474619  14.2316426396444  17  18.2111025509280  20.3144051699426  10  20.7782985583840  16.5356578712647  13.2708146741951  0] ]

  ; local variables that can vary between buses
  set known_route []
  
  ; ORACLE exlusive ( will also be added for other buses, but never used )
  set night_team [ 1 1 1 ]
  set morning_team [ 3 3 3 3 3 3 2 2 2 2 2 1 1 1 1 1 ]
  set total_capacity bus_capacity
  set add_bus_threshold 0.9
  set history n-values 12 [ 0 ]
  set total_ticks_per_day 1440
  set wait_for_votes False
  ;set position_belief n-values 24 []   ; FIXME

end


to execute-actions

  check_inbox ; if votes are in, this function processes them as well
  decide_start_vote
  decide_send_bid
  give_route

  if current_stop > -1 [

    ifelse length known_route = 0 [
      set next_stop choose_next_stop
    ] [
      set next_stop item 0 known_route
      set known_route but-first known_route
    ]

    dropoff_passengers
    pickup_passengers
  ]

  travel-to next_stop

end
